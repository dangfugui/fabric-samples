1、本篇背景

Marbles是IBM开源的区块链项目，基本网络是Hyperledger Fabric，GitHub地址如下：
https://github.com/IBM-Blockchain/marbles


## 富查询配置CouchDB
富查询需要配置CouchDB，进入到 fabric-samples/chaincode-docker-devmode 目录，找到 docker-compose-simple.yaml 配置文件进行修改，修改格式如下：
```yaml
services:
    peer:
        environment:
            ...
            - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp
            ###以下是添加的内容
            - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp
            - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
            - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb:5984 
            - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=
            - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=
        
        depends_on:
            - orderer
            ###以下是添加的内容
            - couchdb
        
    couchdb:
        container_name: couchdb
        image: hyperledger/fabric-couchdb
        # Populate the COUCHDB_USER and COUCHDB_PASSWORD to set an admin user and password
        # for CouchDB. This will prevent CouchDB from operating in an "Admin Party" mode.
        environment:
            - COUCHDB_USER=
            - COUCHDB_PASSWORD=
        ports:
            - 5984:5984

```
## 4、编译和调用链码
确保您搭建并配置好了Hyperledger Fabric的开发环境，我们把上面创建的链码文件夹复制到 fabric-samples/chaincode 目录下。
同时，开启三个终端，确保终端进入到"fabric-samples/chaincode-docker-devmode"目录下。
### 4.1 终端1 - 开启网络 
```text
###删除所有活跃的容器###
docker rm -f $(docker ps -aq)
###清理网络缓存###
docker network prune
###开启网络###
docker-compose -f docker-compose-simple.yaml up
```


### 4.1 终端2 - 编译和运行链码
```text
###进入Docker容器cli###
docker exec -it chaincode bash
###进入到链码对应目录###
cd marbles_chaincode
###编译链码###
go build
###启动Peer节点运行链码###
CORE_PEER_ADDRESS=peer:7052 CORE_CHAINCODE_ID_NAME=mycc:0 ./marbles_chaincode
###如果失败，把"7052"改为"7051"试试看
```
### 4.3 终端3 - 安装和调用链码
```text
### 1、启动Docker CLI容器：
docker exec -it cli bash
2、安装和实例化链码：
peer chaincode install -p chaincodedev/chaincode/marbles_chaincode -n mycc -v 0

peer chaincode instantiate -n mycc -v 0 -c '{"Args":[]}' -C myc

3、初始化弹珠：

分别创建三个弹珠
peer chaincode invoke -n mycc -c '{"Args":["initMarble","1","red","20","Jack"]}' -C myc
peer chaincode invoke -n mycc -c '{"Args":["initMarble","2","green","66","Wenzil"]}' -C myc
peer chaincode invoke -n mycc -c '{"Args":["initMarble","3","blue","88","Li Lei"]}' -C myc

4、通过弹珠ID查询对应的弹珠信息：
peer chaincode invoke -n mycc -c '{"Args":["getMarbleInfoByID","1"]}' -C myc

5、改变弹珠的拥有者：
peer chaincode invoke -n mycc -c '{"Args":["changeMarbleOwner","1","Han Meimei"]}' -C myc

6、查询改变拥有者后的弹珠信息：
peer chaincode invoke -n mycc -c '{"Args":["getMarbleInfoByID","1"]}' -C myc

7、通过弹珠ID删除对应的弹珠：
peer chaincode invoke -n mycc -c '{"Args":["deleteMarbleByID","1"]}' -C myc

8、查询指定ID范围的弹珠信息：
peer chaincode invoke -n mycc -c '{"Args":["getMarbleByRange","2", "3"]}' -C myc

9、查询某个拥有者的所有弹珠信息：
peer chaincode invoke -n mycc -c '{"Args":["getMarbleByOwner","Wenzil"]}' -C myc

10、通过弹珠ID查询所有的交易历史信息：
peer chaincode invoke -n mycc -c '{"Args":["getMarbleHistoryForKey","1"]}' -C myc

```

链接：https://www.jianshu.com/p/c9b5d0bcd0d6。